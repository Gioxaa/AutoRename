{% extends "base.html" %}

{% block content %}
<div class="upload-container" id="drop-area">
    <div class="upload-icon">
        <i class="fas fa-file-pdf"></i>
    </div>
    <h3>Upload PDF File</h3>
    <p>Drag & drop your PDF file here or click to browse</p>
    
    <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
        <input type="file" name="file" id="file-input" class="form-control d-none" accept=".pdf">
        <button type="button" class="btn btn-primary mt-3" id="browse-btn">
            <i class="fas fa-upload me-2"></i> Browse Files
        </button>
        
        <div class="progress-container">
            <div class="progress mt-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <p class="mt-2" id="progress-text">Uploading...</p>
        </div>
    </form>
</div>

<div class="row mt-4">
    <div class="col-md-4 text-center">
        <div class="card h-100 feature-card">
            <div class="card-body">
                <div class="feature-icon">
                    <i class="fas fa-upload text-primary"></i>
                </div>
                <h5 class="card-title">Upload</h5>
                <p class="card-text">Upload your PDF file to get started</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 text-center">
        <div class="card h-100 feature-card">
            <div class="card-body">
                <div class="feature-icon">
                    <i class="fas fa-cogs text-primary"></i>
                </div>
                <h5 class="card-title">Configure</h5>
                <p class="card-text">Set split size and keyword for name detection</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 text-center">
        <div class="card h-100 feature-card">
            <div class="card-body">
                <div class="feature-icon">
                    <i class="fas fa-download text-primary"></i>
                </div>
                <h5 class="card-title">Download</h5>
                <p class="card-text">Get your split and renamed files</p>
            </div>
        </div>
    </div>
</div>

<!-- Features Section -->
<div class="card mt-5">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-star me-2"></i> Features</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="d-flex mb-4">
                    <div class="feature-bullet me-3">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <div>
                        <h6>Automatic Name Detection</h6>
                        <p class="text-muted">Automatically extracts names from PDF content based on keywords</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex mb-4">
                    <div class="feature-bullet me-3">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <div>
                        <h6>Custom Split Size</h6>
                        <p class="text-muted">Split PDFs by any number of pages per output file</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex mb-4">
                    <div class="feature-bullet me-3">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <div>
                        <h6>Preview Files</h6>
                        <p class="text-muted">View your PDFs before and after processing</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex mb-4">
                    <div class="feature-bullet me-3">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <div>
                        <h6>Batch Download</h6>
                        <p class="text-muted">Download all files at once as a ZIP archive</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
    .feature-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .feature-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }
    
    .feature-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        height: 60px;
        width: 60px;
        line-height: 60px;
        border-radius: 50%;
        background-color: rgba(52, 152, 219, 0.1);
        display: inline-block;
        transition: all 0.3s ease;
    }
    
    .feature-card:hover .feature-icon {
        background-color: rgba(52, 152, 219, 0.2);
        transform: scale(1.1);
    }
    
    .feature-bullet {
        font-size: 1.5rem;
        min-width: 30px;
    }
    
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    .upload-icon {
        animation: float 3s ease-in-out infinite;
    }
    
    /* Enhanced progress bar styles */
    .progress {
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .progress-bar {
        background-color: #4CAF50;
        background-image: linear-gradient(45deg, 
                          rgba(255,255,255,.15) 25%, 
                          transparent 25%, 
                          transparent 50%, 
                          rgba(255,255,255,.15) 50%, 
                          rgba(255,255,255,.15) 75%, 
                          transparent 75%, 
                          transparent);
        background-size: 20px 20px;
        transition: width 0.3s ease;
    }
    
    .progress-container {
        display: none;
        margin-top: 20px;
    }
    
    #progress-text {
        font-size: 14px;
        color: #555;
        margin-top: 8px;
        text-align: center;
    }
    
    .upload-container {
        background-color: #f8f9fa;
        border: 2px dashed #ddd;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
        margin-bottom: 30px;
    }
    
    .upload-container:hover {
        border-color: #4CAF50;
    }
    
    .upload-container.bg-light {
        background-color: #e9ecef !important;
        border-color: #4CAF50;
    }
    
    .upload-icon i {
        font-size: 4rem;
        color: #4CAF50;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const uploadForm = document.getElementById('upload-form');
        const progressContainer = document.querySelector('.progress-container');
        const progressBar = document.querySelector('.progress-bar');
        const progressText = document.getElementById('progress-text');
        
        // Open file browser when button is clicked
        browseBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Submit form when file is selected
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.type !== 'application/pdf') {
                    alert('Please select a PDF file.');
                    return;
                }
                
                // Show file name before uploading
                dropArea.querySelector('h3').textContent = 'Uploading: ' + file.name;
                
                // Use optimized upload with XHR for better performance
                uploadFileWithProgress(file);
            }
        });
        
        // Handle drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('bg-light');
            dropArea.style.transform = 'scale(1.02)';
            dropArea.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.1)';
        }
        
        function unhighlight() {
            dropArea.classList.remove('bg-light');
            dropArea.style.transform = 'scale(1)';
            dropArea.style.boxShadow = 'none';
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                const file = files[0];
                if (file.type !== 'application/pdf') {
                    alert('Please drop a PDF file.');
                    return;
                }
                
                // Show file name before uploading
                dropArea.querySelector('h3').textContent = 'Uploading: ' + file.name;
                
                // Use optimized upload
                uploadFileWithProgress(file);
            }
        }
        
        function showProgress() {
            progressContainer.style.display = 'block';
            browseBtn.style.display = 'none';
        }
        
        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
            else return (bytes / 1048576).toFixed(2) + ' MB';
        }
        
        // Helper function to calculate upload speed
        function calculateSpeed(loaded, startTime) {
            const elapsed = (Date.now() - startTime) / 1000; // seconds
            const speed = loaded / elapsed; // bytes per second
            if (speed < 1024) return speed.toFixed(2) + ' B/s';
            else if (speed < 1048576) return (speed / 1024).toFixed(2) + ' KB/s';
            else return (speed / 1048576).toFixed(2) + ' MB/s';
        }
        
        function uploadFileWithProgress(file) {
            showProgress();
            
            // Create FormData and append file
            const formData = new FormData();
            formData.append('file', file);
            
            // Use XHR for better control over upload progress
            const xhr = new XMLHttpRequest();
            const startTime = Date.now();
            let lastLoaded = 0;
            let lastTime = startTime;
            let currentSpeed = '0 KB/s';
            
            // Setup upload progress handler
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.min(Math.round((e.loaded / e.total) * 100), 95);
                    progressBar.style.width = percentComplete + '%';
                    
                    // Calculate speed every second to avoid rapid UI changes
                    const now = Date.now();
                    if (now - lastTime > 500) { // Update speed every 500ms
                        currentSpeed = calculateSpeed(e.loaded - lastLoaded, now - lastTime);
                        lastLoaded = e.loaded;
                        lastTime = now;
                    }
                    
                    // Format progress text with file size and speed
                    const loadedSize = formatFileSize(e.loaded);
                    const totalSize = formatFileSize(e.total);
                    
                    // Display detailed progress information
                    progressText.innerHTML = `<strong>${percentComplete}%</strong> · ${loadedSize} of ${totalSize} · <span style="color:#4CAF50">${currentSpeed}</span>`;
                    
                    // Start "Processing..." message at 95%
                    if (percentComplete >= 95) {
                        progressText.innerHTML = `<strong>Processing...</strong> ${loadedSize} of ${totalSize} · Please wait`;
                    }
                }
            });
            
            // Setup completion handler
            xhr.addEventListener('load', function() {
                if (xhr.status === 200 || xhr.status === 302) {
                    // Show 100% complete before redirecting
                    progressBar.style.width = '100%';
                    progressText.innerHTML = '<strong>Upload complete!</strong> Redirecting...';
                    
                    // Add small delay before redirect for better UX
                    setTimeout(() => {
                        window.location.href = "{{ url_for('configure') }}";
                    }, 800);
                } else {
                    progressText.innerHTML = '<strong style="color:#F44336">Upload failed.</strong> Please try again.';
                    progressBar.style.width = '0%';
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        browseBtn.style.display = 'inline-block';
                    }, 3000);
                }
            });
            
            // Setup error handler
            xhr.addEventListener('error', function() {
                progressText.innerHTML = '<strong style="color:#F44336">Connection error.</strong> Please check your network.';
                progressBar.style.width = '0%';
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    browseBtn.style.display = 'inline-block';
                }, 3000);
            });
            
            // Handle timeout
            xhr.addEventListener('timeout', function() {
                progressText.innerHTML = '<strong style="color:#F44336">Upload timeout.</strong> File may be too large.';
                progressBar.style.width = '0%';
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    browseBtn.style.display = 'inline-block';
                }, 3000);
            });
            
            // Open connection and send the file
            xhr.timeout = 300000; // 5 minutes timeout
            xhr.open('POST', "{{ url_for('upload_file') }}", true);
            xhr.send(formData);
        }
    });
</script>
{% endblock %} 